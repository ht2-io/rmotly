name: Deploy to Dev Server

on:
  push:
    branches: [master]
  workflow_dispatch:

env:
  DEV_HOST: dev1.ht2.io
  DEV_USER: cicd

jobs:
  # TODO: Re-enable tests once code issues are fixed:
  # - event_service.dart:213 - greaterThan not defined for ColumnDateTime
  # - notification_service.dart:156 - StreamNotification not defined
  # - sse_route.dart:10 - Missing Route.handleCall implementation
  # - webhook_route.dart:10 - Missing Route.handleCall implementation

  deploy:
    name: Deploy to Dev Server
    runs-on: ubuntu-latest
    environment:
      name: development
      url: https://dev1.ht2.io
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEV_HOST }}
          username: ${{ env.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            set -e
            echo "Starting deployment to dev server..."
            /opt/rmotly/deploy.sh
            echo "Deployment complete!"

      - name: Verify deployment
        run: |
          echo "Waiting for services to start..."
          sleep 30
          echo "Checking service status via SSH..."

      - name: Check service status
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ env.DEV_HOST }}
          username: ${{ env.DEV_USER }}
          key: ${{ secrets.DEV_SSH_KEY }}
          script: |
            cd /opt/rmotly/rmotly_server
            docker compose ps
            echo "Dev deployment verified!"
